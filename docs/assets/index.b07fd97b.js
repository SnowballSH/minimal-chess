var e,t,o,s,i,r,l,a,n,h,c,u;function d(e){return e>=0&&e<12}function p(e,t){return e>>2==t>>2}function f(e,t){return 1===Math.abs((e>>2)-(t>>2))}class v{constructor(){this.colorToMove=l.Yellow,this.history=[],this.status=o.OnGoing,this.pool=[],this.hashTable=[],this.hash=0,this.board=[new w(i.Xiang,l.Yellow),null,null,new w(i.Xiang,l.Blue),new w(i.Jiang,l.Yellow),new w(i.Zi,l.Yellow),new w(i.Zi,l.Blue),new w(i.Jiang,l.Blue),new w(i.Wang,l.Yellow),null,null,new w(i.Wang,l.Blue)];for(let e=0;e<22;e++)this.hashTable[e]=crypto.getRandomValues(new Uint32Array(10));this.hashTableOther=crypto.getRandomValues(new Uint32Array(2)),this.calculateHash()}static fromFEN(e){const[t,o,s]=e.split(" ");let i=[];for(const a of t){let e=parseInt(a);isNaN(e)?i.push(null):i.push(new w(e%5,Math.floor(e/5)))}let r=[];for(const a of o){let e=parseInt(a);r.push(new w(e%5,Math.floor(e/5)))}let l=new v;return l.board=i,l.pool=r,l.colorToMove=parseInt(s[0]),l.status=parseInt(s[1]),l}toFEN(){let e="";return e+=this.board.map((e=>null===e?"*":(e.type+5*e.color).toString())).join(""),e+=" ",e+=this.pool.filter((e=>void 0!==e)).map((e=>(e.type+5*e.color).toString())).join(""),e+=" ",e+=this.colorToMove,e+=this.status,e}calculateHash(){this.hash=0;for(const[e,t]of this.board.entries())null!=t&&(this.hash^=this.hashTable[e][t.type+5*t.color]);for(const[e,t]of this.pool.entries())this.hash^=this.hashTable[e+12][t.type+5*t.color];this.hash^=this.hashTableOther[this.colorToMove]}*piecesForColor(e){var t;for(const o of this.board.entries())e===(null==(t=o[1])?void 0:t.color)&&(yield o)}*emptySquares(){for(const e of this.board.entries())null===e[1]&&(yield e)}isMyPieceOnIndex(e,t){var o;return(null==(o=this.board[t])?void 0:o.color)===e}isOpponentPieceOnIndex(e,t){var o;return(null==(o=this.board[t])?void 0:o.color)===(1^e)}makeMove(t){if(this.history.push({board:[...this.board],status:this.status,pool:[...this.pool]}),t.flag===e.Revive)this.board[t.to]=this.pool[t.from-12],delete this.pool[t.from-12],this.pool=this.pool.filter((e=>void 0!==e)).sort(((e,t)=>e.color-t.color));else{const s=this.board[t.from];if(this.board[t.from]=null,t.flag===e.Capture){const e=Object.create(this.board[t.to]);this.board[t.to]=s,e.type===i.Jiang&&this.status===o.OnGoing?this.status=e.color===l.Yellow?o.BlueWin:o.YellowWin:(e.color^=1,e.type===i.Hou?this.pool.push(new w(i.Zi,e.color)):this.pool.push(e))}else if(t.flag===e.CapturePromotion){const e=Object.create(this.board[t.to]);this.board[t.to]=null!==s?new w(i.Hou,s.color):null,e.type===i.Jiang&&this.status===o.OnGoing?this.status=e.color===l.Yellow?o.BlueWin:o.YellowWin:(e.color^=1,this.pool.push(e))}else t.flag===e.QuietPromotion?this.board[t.to]=null!==s?new w(i.Hou,s.color):null:t.flag===e.Quiet&&(this.board[t.to]=s)}this.colorToMove^=1,this.calculateHash()}undoMove(){const e=this.history.pop();this.board=e.board,this.status=e.status,this.pool=e.pool,this.colorToMove^=1,this.calculateHash()}*legalMoves(){for(const[t,o]of this.piecesForColor(this.colorToMove))if(null!==o)for(const s of o.pieceDirections()){let r,l;switch(s){case n.N:r=t-4,d(r)&&!this.isMyPieceOnIndex(o.color,r)&&(l=new M(t,r));break;case n.S:r=t+4,d(r)&&!this.isMyPieceOnIndex(o.color,r)&&(l=new M(t,r));break;case n.W:r=t-1,d(r)&&p(t,r)&&!this.isMyPieceOnIndex(o.color,r)&&(l=new M(t,r));break;case n.E:r=t+1,d(r)&&p(t,r)&&!this.isMyPieceOnIndex(o.color,r)&&(l=new M(t,r));break;case n.NW:r=t-5,d(r)&&f(t,r)&&!this.isMyPieceOnIndex(o.color,r)&&(l=new M(t,r));break;case n.NE:r=t-3,d(r)&&f(t,r)&&!this.isMyPieceOnIndex(o.color,r)&&(l=new M(t,r));break;case n.SW:r=t+3,d(r)&&f(t,r)&&!this.isMyPieceOnIndex(o.color,r)&&(l=new M(t,r));break;case n.SE:r=t+5,d(r)&&f(t,r)&&!this.isMyPieceOnIndex(o.color,r)&&(l=new M(t,r))}void 0!==l&&(this.isOpponentPieceOnIndex(this.colorToMove,l.to)&&(l.flag=e.Capture),o.type!==i.Zi||l.to%4!=0&&l.to%4!=3||(l.flag===e.Capture?l.flag=e.CapturePromotion:l.flag=e.QuietPromotion),yield l)}for(const[t,o]of this.pool.entries())if(void 0!==o&&o.color===this.colorToMove)for(const[s]of this.emptySquares())yield new M(12+t,s,e.Revive)}}(t=e||(e={}))[t.CapturePromotion=0]="CapturePromotion",t[t.QuietPromotion=1]="QuietPromotion",t[t.Capture=2]="Capture",t[t.Revive=3]="Revive",t[t.Quiet=4]="Quiet",(s=o||(o={}))[s.OnGoing=0]="OnGoing",s[s.YellowWin=1]="YellowWin",s[s.BlueWin=2]="BlueWin";class M{constructor(e,t,o=4){this.from=e,this.to=t,this.flag=o}}(r=i||(i={}))[r.Jiang=0]="Jiang",r[r.Wang=1]="Wang",r[r.Xiang=2]="Xiang",r[r.Zi=3]="Zi",r[r.Hou=4]="Hou",(a=l||(l={}))[a.Yellow=0]="Yellow",a[a.Blue=1]="Blue";class w{constructor(e,t){this.type=e,this.color=t}pieceDirections(){const e=this;switch(e.type){case 0:return[0,1,2,3,4,5,6,7];case 1:return[n.N,n.E,n.S,n.W];case 2:return[n.NE,n.NW,n.SE,n.SW];case 3:return 0===e.color?[n.E]:[n.W];case 4:return 0===e.color?[0,2,4,5,6,7]:[0,1,2,3,4,6]}}pieceToString(){return"将王相子侯"[this.type]}}(h=n||(n={}))[h.N=0]="N",h[h.NW=1]="NW",h[h.W=2]="W",h[h.SW=3]="SW",h[h.S=4]="S",h[h.SE=5]="SE",h[h.E=6]="E",h[h.NE=7]="NE",(u=c||(c={}))[u.Exact=0]="Exact",u[u.Upper=1]="Upper",u[u.Lower=2]="Lower";const g=66666,m=g*Math.PI;function b(e,t){if(e.status===o.YellowWin)return e.colorToMove===l.Yellow?g-t:-g+t;if(e.status===o.BlueWin)return e.colorToMove===l.Blue?g-t:-g+t;let s=0;for(const o of e.board){if(null===o)continue;const t=e.colorToMove===(null==o?void 0:o.color)?1:-1;switch(null==o?void 0:o.type){case i.Jiang:s+=2e4*t;break;case i.Zi:s+=100*t;break;case i.Wang:case i.Xiang:s+=250*t;break;case i.Hou:s+=300*t}}for(const o of e.pool){const t=e.colorToMove===(null==o?void 0:o.color)?1:-1;switch(null==o?void 0:o.type){case i.Zi:s+=40*t;break;case i.Wang:case i.Xiang:s+=80*t}}return s}const T={lower:-g,upper:g};class y{constructor(){this.scoreTable=new Map,this.moveTable=new Map,this.nodes=0,this.depth=0,this.seldepth=0,this.startTime=(new Date).getTime(),this.durationMS=600}bound(e,t,o,s,i){this.nodes++,this.seldepth=Math.max(s,this.seldepth);let r=this.scoreTable.get({hash:e.hash,depth:Math.max(o,0),isRoot:i});if(void 0===r&&(r=T),r.lower>=t&&(!i||this.moveTable.has(e.hash)))return r.lower;if(r.upper<t)return r.upper;if((new Date).getTime()-this.startTime>this.durationMS)return m;let l=-g;if(o<=0){let t=b(e,s);l=Math.max(l,t)}if(l<=t){let i=this.moveTable.get(e.hash);if(void 0!==i)if(e.makeMove(i),o>0||b(e,s)>=95){let i=-this.bound(e,1-t,o-1,s+1,!1);if(e.undoMove(),i===m)return m;l=Math.max(l,i)}else e.undoMove()}if(l<t){let i=Array.from(e.legalMoves()).map((t=>{e.makeMove(t);let o=b(e,s);return e.undoMove(),{score:-o,move:t}})).sort(((e,t)=>e.score-t.score));for(const r of i){if(!(o>0||-r.score>=95&&b(e,s)-r.score>l))break;{e.makeMove(r.move);let i=-this.bound(e,1-t,o-1,s+1,!1);if(e.undoMove(),i===m)return m;if(l=Math.max(l,i),l>=t){this.moveTable.size>=2e6&&this.moveTable.clear(),this.moveTable.set(e.hash,r.move);break}}}}return this.scoreTable.size>=2e6&&this.scoreTable.clear(),l>=t?this.scoreTable.set({hash:e.hash,depth:o,isRoot:i},{lower:l,upper:r.upper}):l<t&&this.scoreTable.set({hash:e.hash,depth:o,isRoot:i},{lower:r.lower,upper:l}),l}search(e,t,o){this.durationMS=t,this.nodes=0,this.depth=0,this.seldepth=0,this.startTime=(new Date).getTime();let s=null;for(this.depth=1;this.depth<=(void 0===o?100:o);this.depth++){let t=-g,o=g;for(;t<o-8;){let s=Math.floor((t+o+1)/2),i=this.bound(e,s,this.depth,0,!0);if(i===m){t=m;break}i>=s?t=i:o=i}if(t===m)break;let i=this.bound(e,t,this.depth,0,!0);if(i===m)break;if(console.log(`DEPTH ${this.depth} SCORE ${i} NODES ${this.nodes} TIME ${(new Date).getTime()-this.startTime}`),s=this.moveTable.get(e.hash),(new Date).getTime()-this.startTime>this.durationMS||i>66656)break}return s}}let k=new v,x=null;function H(e,t){switch(t.color){case l.Yellow:e.style.backgroundColor="#ffff41";break;case l.Blue:e.style.backgroundColor="#3939f5"}switch(t.type){case i.Xiang:e.innerHTML='<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="M0 0H8L0 8M24 0H32V8M32 24V32H24M0 32H8L0 24">\n</path></svg>';break;case i.Wang:e.innerHTML='<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0">\n</path></svg>';break;case i.Jiang:e.innerHTML='<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="M0 0H8L0 8M24 0H32V8M32 24V32H24M0 32H8L0 24M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0">\n</path></svg>';break;case i.Zi:e.innerHTML=`<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="${(null==t?void 0:t.color)===l.Yellow?"M32 22 38 16 32 10":"M0 22-6 16 0 10"}">\n</path></svg>`;break;case i.Hou:e.innerHTML=`<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="${(null==t?void 0:t.color)===l.Yellow?"M24 0H32V8M32 24V32H24M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0":"M0 0H8L0 8M0 32H8L0 24M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0"}">\n</path></svg>`}e.innerHTML+=`<h3>${(null==t?void 0:t.pieceToString())||""}</h3>`}function W(){for(let o=0;o<12;o++){let e=k.board[o],t=document.querySelector(`#square${o}`);null!==e?H(t,e):(t.innerHTML="",t.style.backgroundColor="#fcfffc")}const e=document.querySelector("#pool");let t=[];e.innerHTML="",k.pool.forEach(((e,o)=>{if(void 0===e)return;let s=document.createElement("div");s.id="poolsq"+o,s.classList.add("square"),H(s,e),t.push(s)})),t.forEach((t=>e.appendChild(t)))}function S(){for(let e=0;e<12;e++)document.querySelector(`#square${e}`).classList.remove("legal-move")}function O(e){S();for(const t of k.legalMoves())t.from===e&&document.querySelector(`#square${t.to}`).classList.add("legal-move")}let Y=!0,q=new class{constructor(){this.tt=new Map,this.depth=0,this.nodes=0,this.seldepth=0}negamax(e,t,s,i,r){let l=s;this.seldepth=Math.max(this.seldepth,r),this.nodes++;let a=this.tt.get(e.hash);if(void 0!==a&&a.depth>=t){switch(a.flag){case 0:return a.value;case 1:i=Math.min(i,a.value);break;case 2:s=Math.max(s,a.value)}if(s>i)return a.value}if(0===t||e.status!==o.OnGoing)return this.q(e,t,s,i,r);let n=Array.from(e.legalMoves()),h=-1/0;for(const o of n){e.makeMove(o);let l=this.negamax(e,t-1,-i,-s,r+1);if(e.undoMove(),h=Math.max(h,-l),(s=Math.max(s,h))>i)break}return this.tt.size>=2e6&&this.tt.clear(),this.tt.size>=2e6&&this.tt.clear(),this.tt.set(e.hash,{depth:t,value:h,flag:h<=l?1:h>=i?2:0}),h}q(t,s,i,r,l){let a=i;this.nodes++,this.seldepth=Math.max(this.seldepth,l);let n=this.tt.get(t.hash);if(void 0!==n&&n.depth>=s){switch(n.flag){case 0:return n.value;case 1:r=Math.min(r,n.value);break;case 2:i=Math.max(i,n.value)}if(i>r)return n.value}let h=Array.from(t.legalMoves()).filter((t=>t.flag===e.Capture));if(t.status!==o.OnGoing||0===h.length)return b(t,l);let c=-1/0;for(const e of h){t.makeMove(e);let o=this.q(t,s-1,-r,-i,l+1);if(t.undoMove(),c=Math.max(c,-o),(i=Math.max(i,c))>r)break}return this.tt.set(t.hash,{depth:s,value:c,flag:c<=a?1:c>=r?2:0}),c}negaRoot(e,t){return this.nodes=0,this.seldepth=0,this.depth=t,this.mtdfNegaRoot(e,-1/0,1/0,t)}mtdfNegaRoot(e,t,o,s){let i=-1/0,r=null,l=Array.from(e.legalMoves());for(const a of l){e.makeMove(a);let l=this.negamax(e,s-1,-o,-t,0);if(e.undoMove(),i=Math.max(i,-l),l>=i&&(r=a),(t=Math.max(t,i))>o)break}return[r,i]}},E=new y,L=new y;async function B(e,t){return(k.colorToMove===l.Yellow?E:L).search(k,e,t)}window.startGame=function(){k=new v,C()};const P=document.querySelector("#yellow-select"),I=document.querySelector("#blue-select"),N=document.querySelector("#status-value");function C(){return S(),W(),Y=!1,k.status===o.YellowWin?(alert("Yellow wins!"),N.innerHTML="Yellow wins",void(Y=!0)):k.status===o.BlueWin?(alert("Blue wins!"),N.innerHTML="Blue wins",void(Y=!0)):void function(){switch(N.innerHTML=k.colorToMove===l.Yellow?"Yellow to Move":"Blue to Move",(k.colorToMove===l.Yellow?P:I).value){case"s1":Y=!0,setTimeout((()=>{B(100).then((e=>{k.makeMove(e),C()}))}),600);break;case"s2":Y=!0,setTimeout((()=>{B(600).then((e=>{k.makeMove(e),C()}))}),600);break;case"s3":Y=!0,setTimeout((()=>{B(1e4,9).then((e=>{k.makeMove(e),C()}))}),600);break;case"b":Y=!0,setTimeout((()=>{(async function(){return q.negaRoot(k,6)})().then((e=>{k.makeMove(e[0]),C()}))}),600);break;case"h":Y=!1}}()}!function(){document.onclick=e=>{if(!Y){const t=e.target.id;if(t.startsWith("square")){const e=parseInt(t.split("square")[1]);for(const t of k.legalMoves())if(t.from===x&&t.to===e)return k.makeMove(t),void C();x===e?(S(),x=null):(O(e),x=e)}else if(t.startsWith("poolsq")){const e=parseInt(t.split("poolsq")[1]);x===12+e?(S(),x=null):(O(12+e),x=12+e)}else S(),x=null}};for(let e=0;e<12;e++)document.querySelector("#board").innerHTML+=`<div class='square' id='square${e}'"></div>`;W()}();
