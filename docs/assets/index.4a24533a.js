var e,o,t,s,i,r,n,l,a,h;function c(e){return e>=0&&e<12}function u(e,o){return e>>2==o>>2}function p(e,o){return 1===Math.abs((e>>2)-(o>>2))}class d{constructor(){this.colorToMove=n.Yellow,this.history=[],this.status=t.OnGoing,this.pool=[],this.hashTable=[],this.hash=0,this.movesSinceLastCapture=0,this.board=[new v(i.Xiang,n.Yellow),null,null,new v(i.Xiang,n.Blue),new v(i.Jiang,n.Yellow),new v(i.Zi,n.Yellow),new v(i.Zi,n.Blue),new v(i.Jiang,n.Blue),new v(i.Wang,n.Yellow),null,null,new v(i.Wang,n.Blue)];for(let e=0;e<22;e++)this.hashTable[e]=crypto.getRandomValues(new Uint32Array(10));this.hashTableOther=crypto.getRandomValues(new Uint32Array(2)),this.calculateHash()}static fromFEN(e){const[o,t,s,i]=e.split(" ");let r=[];for(const a of o){let e=parseInt(a);isNaN(e)?r.push(null):r.push(new v(e%5,Math.floor(e/5)))}let n=[];for(const a of t){let e=parseInt(a);n.push(new v(e%5,Math.floor(e/5)))}let l=new d;l.board=r,l.pool=n,l.colorToMove=parseInt(s[0]),l.status=parseInt(s[1]),l.movesSinceLastCapture=parseInt(i);for(let a=0;a<22;a++)l.hashTable[a]=crypto.getRandomValues(new Uint32Array(10));return l.hashTableOther=crypto.getRandomValues(new Uint32Array(2)),l.calculateHash(),l}toFEN(){let e="";return e+=this.board.map((e=>null===e?"*":(e.type+5*e.color).toString())).join(""),e+=" ",e+=this.pool.filter((e=>void 0!==e)).map((e=>(e.type+5*e.color).toString())).join(""),e+=" ",e+=this.colorToMove,e+=this.status,e+=" ",e+=this.movesSinceLastCapture,e}calculateHash(){this.hash=0;for(const[e,o]of this.board.entries())null!=o&&(this.hash^=this.hashTable[e][o.type+5*o.color]);for(const[e,o]of this.pool.entries())this.hash^=this.hashTable[e+12][o.type+5*o.color];this.hash^=this.hashTableOther[this.colorToMove]}*piecesForColor(e){var o;for(const t of this.board.entries())e===(null==(o=t[1])?void 0:o.color)&&(yield t)}*emptySquares(){for(const e of this.board.entries())null===e[1]&&(yield e)}isMyPieceOnIndex(e,o){var t;return(null==(t=this.board[o])?void 0:t.color)===e}isOpponentPieceOnIndex(e,o){var t;return(null==(t=this.board[o])?void 0:t.color)===(1^e)}makeMove(o){if(this.history.push({board:[...this.board],status:this.status,pool:[...this.pool],msc:this.movesSinceLastCapture}),o.flag===e.Revive)this.board[o.to]=this.pool[o.from-12],delete this.pool[o.from-12],this.pool=this.pool.filter((e=>void 0!==e)).sort(((e,o)=>e.color-o.color));else{const s=this.board[o.from];if(this.board[o.from]=null,o.flag===e.Capture){const e=Object.create(this.board[o.to]);this.board[o.to]=s,e.type===i.Jiang&&this.status===t.OnGoing?this.status=e.color===n.Yellow?t.BlueWin:t.YellowWin:(e.color^=1,e.type===i.Hou?this.pool.push(new v(i.Zi,e.color)):this.pool.push(e))}else if(o.flag===e.CapturePromotion){const e=Object.create(this.board[o.to]);this.board[o.to]=null!==s?new v(i.Hou,s.color):null,e.type===i.Jiang&&this.status===t.OnGoing?this.status=e.color===n.Yellow?t.BlueWin:t.YellowWin:(e.color^=1,this.pool.push(e))}else o.flag===e.QuietPromotion?this.board[o.to]=null!==s?new v(i.Hou,s.color):null:o.flag===e.Quiet&&(this.board[o.to]=s)}this.colorToMove^=1,this.calculateHash(),o.flag===e.Capture?this.movesSinceLastCapture=0:this.movesSinceLastCapture++,this.status===t.OnGoing&&this.movesSinceLastCapture>=20&&(this.status=t.Draw)}undoMove(){const e=this.history.pop();this.board=e.board,this.status=e.status,this.pool=e.pool,this.colorToMove^=1,this.movesSinceLastCapture=e.msc,this.calculateHash()}*legalMoves(){for(const[o,t]of this.piecesForColor(this.colorToMove))if(null!==t)for(const s of t.pieceDirections()){let r,n;switch(s){case a.N:r=o-4,c(r)&&!this.isMyPieceOnIndex(t.color,r)&&(n=new w(o,r));break;case a.S:r=o+4,c(r)&&!this.isMyPieceOnIndex(t.color,r)&&(n=new w(o,r));break;case a.W:r=o-1,c(r)&&u(o,r)&&!this.isMyPieceOnIndex(t.color,r)&&(n=new w(o,r));break;case a.E:r=o+1,c(r)&&u(o,r)&&!this.isMyPieceOnIndex(t.color,r)&&(n=new w(o,r));break;case a.NW:r=o-5,c(r)&&p(o,r)&&!this.isMyPieceOnIndex(t.color,r)&&(n=new w(o,r));break;case a.NE:r=o-3,c(r)&&p(o,r)&&!this.isMyPieceOnIndex(t.color,r)&&(n=new w(o,r));break;case a.SW:r=o+3,c(r)&&p(o,r)&&!this.isMyPieceOnIndex(t.color,r)&&(n=new w(o,r));break;case a.SE:r=o+5,c(r)&&p(o,r)&&!this.isMyPieceOnIndex(t.color,r)&&(n=new w(o,r))}void 0!==n&&(this.isOpponentPieceOnIndex(this.colorToMove,n.to)&&(n.flag=e.Capture),t.type!==i.Zi||n.to%4!=0&&n.to%4!=3||(n.flag===e.Capture?n.flag=e.CapturePromotion:n.flag=e.QuietPromotion),yield n)}for(const[o,t]of this.pool.entries())if(void 0!==t&&t.color===this.colorToMove)for(const[s]of this.emptySquares())yield new w(12+o,s,e.Revive)}}(o=e||(e={}))[o.CapturePromotion=0]="CapturePromotion",o[o.QuietPromotion=1]="QuietPromotion",o[o.Capture=2]="Capture",o[o.Revive=3]="Revive",o[o.Quiet=4]="Quiet",(s=t||(t={}))[s.OnGoing=0]="OnGoing",s[s.YellowWin=1]="YellowWin",s[s.BlueWin=2]="BlueWin",s[s.Draw=3]="Draw";class w{constructor(e,o,t=4){this.from=e,this.to=o,this.flag=t}}(r=i||(i={}))[r.Jiang=0]="Jiang",r[r.Wang=1]="Wang",r[r.Xiang=2]="Xiang",r[r.Zi=3]="Zi",r[r.Hou=4]="Hou",(l=n||(n={}))[l.Yellow=0]="Yellow",l[l.Blue=1]="Blue";class v{constructor(e,o){this.type=e,this.color=o}pieceDirections(){const e=this;switch(e.type){case 0:return[0,1,2,3,4,5,6,7];case 1:return[a.N,a.E,a.S,a.W];case 2:return[a.NE,a.NW,a.SE,a.SW];case 3:return 0===e.color?[a.E]:[a.W];case 4:return 0===e.color?[0,2,4,5,6,7]:[0,1,2,3,4,6]}}pieceToString(){return"将王相子侯"[this.type]}}(h=a||(a={}))[h.N=0]="N",h[h.NW=1]="NW",h[h.W=2]="W",h[h.SW=3]="SW",h[h.S=4]="S",h[h.SE=5]="SE",h[h.E=6]="E",h[h.NE=7]="NE";const f=66666,M=f*Math.PI;function m(e,o){if(e.status===t.YellowWin)return e.colorToMove===n.Yellow?f-o:-f+o;if(e.status===t.BlueWin)return e.colorToMove===n.Blue?f-o:-f+o;if(e.status===t.Draw)return 0;let s=0;for(const t of e.board){if(null===t)continue;const o=e.colorToMove===(null==t?void 0:t.color)?1:-1;switch(null==t?void 0:t.type){case i.Jiang:s+=2e4*o;break;case i.Zi:s+=100*o;break;case i.Wang:case i.Xiang:s+=250*o;break;case i.Hou:s+=300*o}}for(const t of e.pool){const o=e.colorToMove===(null==t?void 0:t.color)?1:-1;switch(null==t?void 0:t.type){case i.Zi:s+=40*o;break;case i.Wang:case i.Xiang:s+=80*o}}return s}const g={lower:-f,upper:f};class b{constructor(){this.scoreTable=new Map,this.moveTable=new Map,this.nodes=0,this.depth=0,this.seldepth=0,this.startTime=(new Date).getTime(),this.durationMS=600}bound(e,o,t,s,i){this.nodes++,this.seldepth=Math.max(s,this.seldepth);let r=this.scoreTable.get({hash:e.hash,depth:Math.max(t,0),isRoot:i});if(void 0===r&&(r=g),r.lower>=o&&(!i||this.moveTable.has(e.hash)))return r.lower;if(r.upper<o)return r.upper;if((new Date).getTime()-this.startTime>this.durationMS)return M;let n=-f;if(t<=0){let o=m(e,s);n=Math.max(n,o)}if(n<=o){let i=this.moveTable.get(e.hash);if(void 0!==i)if(e.makeMove(i),t>0||m(e,s)>=95){let i=-this.bound(e,1-o,t-1,s+1,!1);if(e.undoMove(),i===M)return M;n=Math.max(n,i)}else e.undoMove()}if(n<o){let i=Array.from(e.legalMoves()).map((o=>{e.makeMove(o);let t=m(e,s);return e.undoMove(),{score:-t,move:o}})).sort(((e,o)=>e.score-o.score));for(const r of i){if(!(t>0||-r.score>=95&&m(e,s)-r.score>n))break;{e.makeMove(r.move);let i=-this.bound(e,1-o,t-1,s+1,!1);if(e.undoMove(),i===M)return M;if(n=Math.max(n,i),n>=o){this.moveTable.size>=2e6&&this.moveTable.clear(),this.moveTable.set(e.hash,r.move);break}}}}return this.scoreTable.size>=2e6&&this.scoreTable.clear(),n>=o?this.scoreTable.set({hash:e.hash,depth:t,isRoot:i},{lower:n,upper:r.upper}):n<o&&this.scoreTable.set({hash:e.hash,depth:t,isRoot:i},{lower:r.lower,upper:n}),n}search(e,o,t){this.durationMS=o,this.nodes=0,this.depth=0,this.seldepth=0,this.startTime=(new Date).getTime();let s=null;for(this.depth=1;this.depth<=(void 0===t?100:t);this.depth++){let o=-f,t=f;for(;o<t-8;){let s=Math.floor((o+t+1)/2),i=this.bound(e,s,this.depth,0,!0);if(i===M){o=M;break}i>=s?o=i:t=i}if(o===M)break;let i=this.bound(e,o,this.depth,0,!0);if(i===M)break;if(console.log(`DEPTH ${this.depth} SCORE ${i} NODES ${this.nodes} TIME ${(new Date).getTime()-this.startTime}`),s=this.moveTable.get(e.hash),(new Date).getTime()-this.startTime>this.durationMS||i>66656)break}return s}}let T=new d,y=null;function S(e,o){switch(o.color){case n.Yellow:e.style.backgroundColor="#ffff41";break;case n.Blue:e.style.backgroundColor="#3939f5"}switch(o.type){case i.Xiang:e.innerHTML='<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="M0 0H8L0 8M24 0H32V8M32 24V32H24M0 32H8L0 24">\n</path></svg>';break;case i.Wang:e.innerHTML='<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0">\n</path></svg>';break;case i.Jiang:e.innerHTML='<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="M0 0H8L0 8M24 0H32V8M32 24V32H24M0 32H8L0 24M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0">\n</path></svg>';break;case i.Zi:e.innerHTML=`<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="${(null==o?void 0:o.color)===n.Yellow?"M32 22 38 16 32 10":"M0 22-6 16 0 10"}">\n</path></svg>`;break;case i.Hou:e.innerHTML=`<svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="${(null==o?void 0:o.color)===n.Yellow?"M24 0H32V8M32 24V32H24M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0":"M0 0H8L0 8M0 32H8L0 24M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0"}">\n</path></svg>`}e.innerHTML+=`<h3>${(null==o?void 0:o.pieceToString())||""}</h3>`}function H(){for(let t=0;t<12;t++){let e=T.board[t],o=document.querySelector(`#square${t}`);null!==e?S(o,e):(o.innerHTML="",o.style.backgroundColor="#fcfffc")}const e=document.querySelector("#pool");let o=[];e.innerHTML="",T.pool.forEach(((e,t)=>{if(void 0===e)return;let s=document.createElement("div");s.id="poolsq"+t,s.classList.add("square"),S(s,e),o.push(s)})),o.forEach((o=>e.appendChild(o)))}function k(){for(let e=0;e<12;e++)document.querySelector(`#square${e}`).classList.remove("legal-move")}function W(e){k();for(const o of T.legalMoves())o.from===e&&document.querySelector(`#square${o.to}`).classList.add("legal-move")}let L=!0,x=new b,O=new b;async function C(e,o){return(T.colorToMove===n.Yellow?x:O).search(T,e,o)}window.startGame=function(){T=new d,q()};const Y=document.querySelector("#yellow-select"),B=document.querySelector("#blue-select"),E=document.querySelector("#status-value");function q(){return k(),H(),L=!1,T.status===t.YellowWin?(alert("Yellow wins!"),E.innerHTML="Yellow wins",void(L=!0)):T.status===t.BlueWin?(alert("Blue wins!"),E.innerHTML="Blue wins",void(L=!0)):T.status===t.Draw?(alert("Draw (by 20 non-capture moves)!"),E.innerHTML="Draw (by 20 non-capture moves)",void(L=!0)):void function(){switch(E.innerHTML=T.colorToMove===n.Yellow?"Yellow to Move":"Blue to Move",(T.colorToMove===n.Yellow?Y:B).value){case"s1":L=!0,setTimeout((()=>{C(100).then((e=>{T.makeMove(e),q()}))}),200);break;case"s2":L=!0,setTimeout((()=>{C(600).then((e=>{T.makeMove(e),q()}))}),200);break;case"s3":L=!0,setTimeout((()=>{C(5e3,10).then((e=>{T.makeMove(e),q()}))}),200);break;case"h":L=!1}}()}!function(){document.onclick=e=>{if(!L){const o=e.target.id;if(o.startsWith("square")){const e=parseInt(o.split("square")[1]);for(const o of T.legalMoves())if(o.from===y&&o.to===e)return T.makeMove(o),void q();y===e?(k(),y=null):(W(e),y=e)}else if(o.startsWith("poolsq")){const e=parseInt(o.split("poolsq")[1]);y===12+e?(k(),y=null):(W(12+e),y=12+e)}else k(),y=null}};for(let e=0;e<12;e++)document.querySelector("#board").innerHTML+=`<div class='square' id='square${e}'"></div>`;H()}();
