var e,t,o,s,i,n,r,l,a,h;function c(e){return e>=0&&e<12}function u(e,t){return e>>2==t>>2}function v(e,t){return 1===Math.abs((e>>2)-(t>>2))}class d{constructor(){this.colorToMove=r.Yellow,this.history=[],this.status=o.OnGoing,this.pool=[],this.hashTable=[],this.hash=0,this.movesSinceLastCapture=0,this.board=[new p(i.Xiang,r.Yellow),null,null,new p(i.Xiang,r.Blue),new p(i.Jiang,r.Yellow),new p(i.Zi,r.Yellow),new p(i.Zi,r.Blue),new p(i.Jiang,r.Blue),new p(i.Wang,r.Yellow),null,null,new p(i.Wang,r.Blue)];for(let e=0;e<22;e++)this.hashTable[e]=crypto.getRandomValues(new Uint32Array(10));this.hashTableOther=crypto.getRandomValues(new Uint32Array(2)),this.calculateHash()}static fromFEN(e){const[t,o,s,i]=e.split(" ");let n=[];for(const a of t){let e=parseInt(a);isNaN(e)?n.push(null):n.push(new p(e%5,Math.floor(e/5)))}let r=[];for(const a of o){let e=parseInt(a);r.push(new p(e%5,Math.floor(e/5)))}let l=new d;l.board=n,l.pool=r,l.colorToMove=parseInt(s[0]),l.status=parseInt(s[1]),l.movesSinceLastCapture=parseInt(i);for(let a=0;a<22;a++)l.hashTable[a]=crypto.getRandomValues(new Uint32Array(10));return l.hashTableOther=crypto.getRandomValues(new Uint32Array(2)),l.calculateHash(),l}toFEN(){let e="";return e+=this.board.map((e=>null===e?"*":(e.type+5*e.color).toString())).join(""),e+=" ",e+=this.pool.filter((e=>void 0!==e)).map((e=>(e.type+5*e.color).toString())).join(""),e+=" ",e+=this.colorToMove,e+=this.status,e+=" ",e+=this.movesSinceLastCapture,e}calculateHash(){this.hash=0;for(const[e,t]of this.board.entries())null!=t&&(this.hash^=this.hashTable[e][t.type+5*t.color]);for(const[e,t]of this.pool.entries())this.hash^=this.hashTable[e+12][t.type+5*t.color];this.hash^=this.hashTableOther[this.colorToMove]}*piecesForColor(e){var t;for(const o of this.board.entries())e===(null==(t=o[1])?void 0:t.color)&&(yield o)}*emptySquares(){for(const e of this.board.entries())null===e[1]&&(yield e)}isMyPieceOnIndex(e,t){var o;return(null==(o=this.board[t])?void 0:o.color)===e}isOpponentPieceOnIndex(e,t){var o;return(null==(o=this.board[t])?void 0:o.color)===(1^e)}makeMove(t){if(this.history.push({board:[...this.board],status:this.status,pool:[...this.pool],msc:this.movesSinceLastCapture}),t.flag===e.Revive)this.board[t.to]=this.pool[t.from-12],delete this.pool[t.from-12],this.pool=this.pool.filter((e=>void 0!==e)).sort(((e,t)=>e.color-t.color));else{const s=this.board[t.from];if(this.board[t.from]=null,t.flag===e.Capture){const e=Object.create(this.board[t.to]);this.board[t.to]=s,e.type===i.Jiang&&this.status===o.OnGoing?this.status=e.color===r.Yellow?o.BlueWin:o.YellowWin:(e.color^=1,e.type===i.Hou?this.pool.push(new p(i.Zi,e.color)):this.pool.push(e))}else if(t.flag===e.CapturePromotion){const e=Object.create(this.board[t.to]);this.board[t.to]=null!==s?new p(i.Hou,s.color):null,e.type===i.Jiang&&this.status===o.OnGoing?this.status=e.color===r.Yellow?o.BlueWin:o.YellowWin:(e.color^=1,this.pool.push(e))}else t.flag===e.QuietPromotion?this.board[t.to]=null!==s?new p(i.Hou,s.color):null:t.flag===e.Quiet&&(this.board[t.to]=s)}this.colorToMove^=1,this.calculateHash(),t.flag===e.Capture?this.movesSinceLastCapture=0:this.movesSinceLastCapture++,this.status===o.OnGoing&&this.movesSinceLastCapture>=20&&(this.status=o.Draw)}undoMove(){const e=this.history.pop();this.board=e.board,this.status=e.status,this.pool=e.pool,this.colorToMove^=1,this.movesSinceLastCapture=e.msc,this.calculateHash()}*legalMoves(){for(const[t,o]of this.piecesForColor(this.colorToMove))if(null!==o)for(const s of o.pieceDirections()){let n,r;switch(s){case a.N:n=t-4,c(n)&&!this.isMyPieceOnIndex(o.color,n)&&(r=new w(t,n));break;case a.S:n=t+4,c(n)&&!this.isMyPieceOnIndex(o.color,n)&&(r=new w(t,n));break;case a.W:n=t-1,c(n)&&u(t,n)&&!this.isMyPieceOnIndex(o.color,n)&&(r=new w(t,n));break;case a.E:n=t+1,c(n)&&u(t,n)&&!this.isMyPieceOnIndex(o.color,n)&&(r=new w(t,n));break;case a.NW:n=t-5,c(n)&&v(t,n)&&!this.isMyPieceOnIndex(o.color,n)&&(r=new w(t,n));break;case a.NE:n=t-3,c(n)&&v(t,n)&&!this.isMyPieceOnIndex(o.color,n)&&(r=new w(t,n));break;case a.SW:n=t+3,c(n)&&v(t,n)&&!this.isMyPieceOnIndex(o.color,n)&&(r=new w(t,n));break;case a.SE:n=t+5,c(n)&&v(t,n)&&!this.isMyPieceOnIndex(o.color,n)&&(r=new w(t,n))}void 0!==r&&(this.isOpponentPieceOnIndex(this.colorToMove,r.to)&&(r.flag=e.Capture),o.type!==i.Zi||r.to%4!=0&&r.to%4!=3||(r.flag===e.Capture?r.flag=e.CapturePromotion:r.flag=e.QuietPromotion),yield r)}for(const[t,o]of this.pool.entries())if(void 0!==o&&o.color===this.colorToMove)for(const[s]of this.emptySquares())yield new w(12+t,s,e.Revive)}}(t=e||(e={}))[t.CapturePromotion=0]="CapturePromotion",t[t.QuietPromotion=1]="QuietPromotion",t[t.Capture=2]="Capture",t[t.Revive=3]="Revive",t[t.Quiet=4]="Quiet",(s=o||(o={}))[s.OnGoing=0]="OnGoing",s[s.YellowWin=1]="YellowWin",s[s.BlueWin=2]="BlueWin",s[s.Draw=3]="Draw";class w{constructor(e,t,o=4){this.from=e,this.to=t,this.flag=o}}(n=i||(i={}))[n.Jiang=0]="Jiang",n[n.Wang=1]="Wang",n[n.Xiang=2]="Xiang",n[n.Zi=3]="Zi",n[n.Hou=4]="Hou",(l=r||(r={}))[l.Yellow=0]="Yellow",l[l.Blue=1]="Blue";class p{constructor(e,t){this.type=e,this.color=t}pieceDirections(){const e=this;switch(e.type){case 0:return[0,1,2,3,4,5,6,7];case 1:return[a.N,a.E,a.S,a.W];case 2:return[a.NE,a.NW,a.SE,a.SW];case 3:return 0===e.color?[a.E]:[a.W];case 4:return 0===e.color?[0,2,4,5,6,7]:[0,1,2,3,4,6]}}pieceToString(){return"将王相子侯"[this.type]}}(h=a||(a={}))[h.N=0]="N",h[h.NW=1]="NW",h[h.W=2]="W",h[h.SW=3]="SW",h[h.S=4]="S",h[h.SE=5]="SE",h[h.E=6]="E",h[h.NE=7]="NE";const f=66666,g=f*Math.PI;function M(e,t){if(e.status===o.YellowWin)return e.colorToMove===r.Yellow?f-t:-f+t;if(e.status===o.BlueWin)return e.colorToMove===r.Blue?f-t:-f+t;if(e.status===o.Draw)return 0;let s=0;for(const o of e.board){if(null===o)continue;const t=e.colorToMove===(null==o?void 0:o.color)?1:-1;switch(null==o?void 0:o.type){case i.Jiang:s+=2e4*t;break;case i.Zi:s+=100*t;break;case i.Wang:case i.Xiang:s+=250*t;break;case i.Hou:s+=300*t}}for(const o of e.pool){const t=e.colorToMove===(null==o?void 0:o.color)?1:-1;switch(null==o?void 0:o.type){case i.Zi:s+=40*t;break;case i.Wang:case i.Xiang:s+=80*t}}return s}const m={lower:-f,upper:f};class b{constructor(){this.scoreTable=new Map,this.moveTable=new Map,this.nodes=0,this.depth=0,this.seldepth=0,this.startTime=(new Date).getTime(),this.durationMS=600}bound(e,t,o,s,i){this.nodes++,this.seldepth=Math.max(s,this.seldepth);let n=this.scoreTable.get({hash:e.hash,depth:Math.max(o,0),isRoot:i});if(void 0===n&&(n=m),n.lower>=t&&(!i||this.moveTable.has(e.hash)))return n.lower;if(n.upper<t)return n.upper;if((new Date).getTime()-this.startTime>this.durationMS)return g;let r=-f;if(o<=0){let t=M(e,s);r=Math.max(r,t)}if(r<=t){let i=this.moveTable.get(e.hash);if(void 0!==i)if(e.makeMove(i),o>0||M(e,s)>=95){let i=-this.bound(e,1-t,o-1,s+1,!1);if(e.undoMove(),i===g)return g;r=Math.max(r,i)}else e.undoMove()}if(r<t){let i=Array.from(e.legalMoves()).map((t=>{e.makeMove(t);let o=M(e,s);return e.undoMove(),{score:-o,move:t}})).sort(((e,t)=>e.score-t.score));for(const n of i){if(!(o>0||-n.score>=95&&M(e,s)-n.score>r))break;{e.makeMove(n.move);let i=-this.bound(e,1-t,o-1,s+1,!1);if(e.undoMove(),i===g)return g;if(r=Math.max(r,i),r>=t){this.moveTable.size>=2e6&&this.moveTable.clear(),this.moveTable.set(e.hash,n.move);break}}}}return this.scoreTable.size>=2e6&&this.scoreTable.clear(),r>=t?this.scoreTable.set({hash:e.hash,depth:o,isRoot:i},{lower:r,upper:n.upper}):r<t&&this.scoreTable.set({hash:e.hash,depth:o,isRoot:i},{lower:n.lower,upper:r}),r}search(e,t,o){this.durationMS=t,this.nodes=0,this.depth=0,this.seldepth=0,this.startTime=(new Date).getTime();let s=null;for(this.depth=1;this.depth<=(void 0===o?100:o);this.depth++){let t=-f,o=f;for(;t<o-8;){let s=Math.floor((t+o+1)/2),i=this.bound(e,s,this.depth,0,!0);if(i===g){t=g;break}i>=s?t=i:o=i}if(t===g)break;let i=this.bound(e,t,this.depth,0,!0);if(i===g)break;if(console.log(`DEPTH ${this.depth} SCORE ${i} NODES ${this.nodes} TIME ${(new Date).getTime()-this.startTime}`),s=this.moveTable.get(e.hash),(new Date).getTime()-this.startTime>this.durationMS||i>66656)break}return s}}let y=new d,T=null;function x(e,t){switch(t.color){case r.Yellow:e.style.backgroundColor="#ffe641";break;case r.Blue:e.style.backgroundColor="#3952f5"}switch(t.type){case i.Xiang:e.innerHTML='<div><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="M0 0H8L0 8M24 0H32V8M32 24V32H24M0 32H8L0 24">\n</path></svg><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<text x="4" y="24.5" style="font-size: 23px; font-weight: 500; font-family: \'Ma Shan Zheng\', cursive;">相</text></svg></div>\n</div>';break;case i.Wang:e.innerHTML='<div><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0">\n</path></svg><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<text x="4.5" y="24.5" style="font-size: 23px; font-weight: 500; font-family: \'Ma Shan Zheng\', cursive;">王</text></svg></div>\n</div>';break;case i.Jiang:e.innerHTML='<div><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="M0 0H8L0 8M24 0H32V8M32 24V32H24M0 32H8L0 24M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0">\n</path></svg><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<text x="4.5" y="24.5" style="font-size: 23px; font-weight: 500; font-family: \'Ma Shan Zheng\', cursive;">将</text></svg></div>\n</div>';break;case i.Zi:e.innerHTML=`<div><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="${(null==t?void 0:t.color)===r.Yellow?"M32 22 38 16 32 10":"M0 22-6 16 0 10"}">\n</path></svg><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<text x="4.5" y="24.5" style="font-size: 23px; font-weight: 500; font-family: 'Ma Shan Zheng', cursive;">子</text></svg></div>\n</div>`;break;case i.Hou:e.innerHTML=`<div><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<path d="${(null==t?void 0:t.color)===r.Yellow?"M24 0H32V8M32 24V32H24M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0":"M0 0H8L0 8M0 32H8L0 24M0 22-6 16 0 10M10 32 16 38 22 32M32 22 38 16 32 10M22 0 16-6 10 0"}">\n</path></svg><svg viewBox="0 0 32 32" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">\n<text x="4.5" y="24.5" style="font-size: 23px; font-weight: 500; font-family: 'Ma Shan Zheng', cursive;">侯</text></svg></div>\n</div>`}}function S(){for(let o=0;o<12;o++){let e=y.board[o],t=document.querySelector(`#square${o}`);null!==e?x(t,e):(t.innerHTML="",t.style.backgroundColor="#fcfffc")}const e=document.querySelector("#pool");let t=[];e.innerHTML="",y.pool.forEach(((e,o)=>{if(void 0===e)return;let s=document.createElement("div");s.id="poolsq"+o,s.classList.add("square"),x(s,e),t.push(s)})),t.forEach((t=>e.appendChild(t)))}function k(){for(let e=0;e<12;e++)document.querySelector(`#square${e}`).classList.remove("legal-move")}function H(e){k();for(const t of y.legalMoves())t.from===e&&document.querySelector(`#square${t.to}`).classList.add("legal-move")}let W=!0,L=new b,B=new b;async function O(e,t){return(y.colorToMove===r.Yellow?L:B).search(y,e,t)}window.startGame=function(){y=new d,q()};const C=document.querySelector("#yellow-select"),Y=document.querySelector("#blue-select"),E=document.querySelector("#status-value");function q(){return k(),S(),W=!1,y.status===o.YellowWin?(alert("Yellow wins!"),E.innerHTML="Yellow wins",void(W=!0)):y.status===o.BlueWin?(alert("Blue wins!"),E.innerHTML="Blue wins",void(W=!0)):y.status===o.Draw?(alert("Draw (by 20 non-capture moves)!"),E.innerHTML="Draw (by 20 non-capture moves)",void(W=!0)):void function(){switch(E.innerHTML=y.colorToMove===r.Yellow?"Yellow to Move":"Blue to Move",(y.colorToMove===r.Yellow?C:Y).value){case"s1":W=!0,setTimeout((()=>{O(100).then((e=>{y.makeMove(e),q()}))}),300);break;case"s2":W=!0,setTimeout((()=>{O(600).then((e=>{y.makeMove(e),q()}))}),300);break;case"s3":W=!0,setTimeout((()=>{O(5e3,10).then((e=>{y.makeMove(e),q()}))}),300);break;case"h":W=!1}}()}!function(){document.onclick=e=>{if(!W){const t=e.target.id;if(t.startsWith("square")){const e=parseInt(t.split("square")[1]);for(const t of y.legalMoves())if(t.from===T&&t.to===e)return y.makeMove(t),void q();T===e?(k(),T=null):(H(e),T=e)}else if(t.startsWith("poolsq")){const e=parseInt(t.split("poolsq")[1]);T===12+e?(k(),T=null):(H(12+e),T=12+e)}else k(),T=null}};for(let e=0;e<12;e++)document.querySelector("#board").innerHTML+=`<div class='square' id='square${e}'"></div>`;S()}();
